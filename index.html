<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      .video-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin: 20px;
      }
      .media-item {
        width: 300px;
        cursor: pointer;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
      }
      .media-item:hover {
        background-color: #f0f0f0;
      }
      .media-item img {
        width: 100%;
        height: auto;
      }
      .controls {
        margin: 20px;
      }
      .controls button {
        padding: 10px 20px;
        margin: 0 10px;
      }
      .media-type {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
      }
      .media-item {
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button class="button">Loading</button>
      <button id="prevVideo" disabled>Previous</button>
      <button id="nextVideo" disabled>Next</button>
      <button id="stopCast" disabled>Stop Casting</button>
    </div>
    <div style="margin: 20px;">
      <h2>HLS Player</h2>
      <p>This player will show an AirPlay button on iOS yes.</p>
      <video id="hlsPlayer" style="width: 100%; max-width: 600px;" controls playsinline autoplay muted></video>
    </div>
    <div class="video-container">
      <div class="media-item" data-media="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" data-type="video">
        <img src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/BigBuckBunny.jpg" alt="Big Buck Bunny">
        <h3>Big Buck Bunny</h3>
        <span class="media-type">Video</span>
      </div>
      <div class="media-item" data-media="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ElephantsDream.jpg" data-type="image">
        <img src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ElephantsDream.jpg" alt="Elephants Dream">
        <h3>Elephants Dream Image</h3>
        <span class="media-type">Image</span>
      </div>
      <div class="media-item" data-media="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4" data-type="video">
        <img src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ForBiggerBlazes.jpg" alt="For Bigger Blazes">
        <h3>For Bigger Blazes</h3>
        <span class="media-type">Video</span>
      </div>
      <div class="media-item" data-media="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ForBiggerEscapes.jpg" data-type="image">
        <img src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/ForBiggerEscapes.jpg" alt="For Bigger Escapes">
        <h3>For Bigger Escapes Image</h3>
        <span class="media-type">Image</span>
      </div>
      <div class="media-item" data-media="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8" data-type="hls">
        
        <h3>HLS BipBop Stream</h3>
        <span class="media-type">HLS</span>
      </div>
    </div>
  </body>
  <script>
    var currentMediaIndex = 0;
    var mediaItems = [];
    var currentSession = null;

    var initializeCastApi = function() {
      console.log('initializeCastApi');

      var sessionRequest = new chrome.cast.SessionRequest(
        chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);
      var apiConfig = new chrome.cast.ApiConfig(
        sessionRequest, sessionListener, receiverListener);
      chrome.cast.initialize(apiConfig, onInitSuccess, onError);
    };

    if (!chrome.cast || !chrome.cast.isAvailable) {
      setTimeout(initializeCastApi, 1000);
    }

    function onInitSuccess() {
      console.log('onInitSuccess');
      // Initialize media array
      $('.media-item').each(function() {
        mediaItems.push({
          url: $(this).data('media'),
          type: $(this).data('type')
        });
      });
    }

    function onError(e) {
      console.log('onError', e);
    }

    function sessionListener(e) {
      console.log('sessionListener', e);
    }

    function receiverListener(availability) {
      console.log('receiverListener', availability);

      if(availability === chrome.cast.ReceiverAvailability.AVAILABLE) {
        $(".button").removeAttr("disabled").text("Start");
        $("#prevVideo, #nextVideo, #stopCast").removeAttr("disabled");
      }
    }

    function onSessionRequestSuccess(session) {
      console.log('onSessionRequestSuccess', session);
      currentSession = session;
      playCurrentMedia();
    }

    function playCurrentMedia() {
      if (!currentSession) return;
      
      const currentMedia = mediaItems[currentMediaIndex];
      let contentType;
      switch (currentMedia.type) {
        case 'video':
          contentType = 'video/mp4';
          break;
        case 'hls':
          contentType = 'application/vnd.apple.mpegurl';
          break;
        case 'image':
        default:
          contentType = 'image/jpeg';
          break;
      }
      const mediaInfo = new chrome.cast.media.MediaInfo(
        currentMedia.url,
        contentType
      );
      
      const request = new chrome.cast.media.LoadRequest(mediaInfo);
      currentSession.loadMedia(request, onMediaLoadSuccess, onError);
    }

    function onMediaLoadSuccess(e) {
      console.log('onMediaLoadSuccess', e);
    }

    function stopCasting() {
      if (currentSession) {
        currentSession.stop();
        currentSession = null;
      }
    }

    $(".button").click(function() {
      chrome.cast.requestSession(onSessionRequestSuccess, onError);
    });

    $("#prevVideo").click(function() {
      if (currentMediaIndex > 0) {
        currentMediaIndex--;
        playCurrentMedia();
      }
    });

    $("#nextVideo").click(function() {
      if (currentMediaIndex < mediaItems.length - 1) {
        currentMediaIndex++;
        playCurrentMedia();
      }
    });

    $("#stopCast").click(function() {
      stopCasting();
    });

    $(".media-item").click(function() {
      currentMediaIndex = $(this).index();
      const currentMedia = mediaItems[currentMediaIndex];
      if (currentSession) {
        playCurrentMedia();
      } else {
        if (currentMedia.type === 'hls') {
          playHlsLocally(currentMedia.url);
        } else {
          chrome.cast.requestSession(onSessionRequestSuccess, onError);
        }
      }
    });

    var hlsPlayer = document.getElementById('hlsPlayer');
    var hls;

    function playHlsLocally(url) {
      if (hls) {
        hls.destroy();
      }

      if (hlsPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        hlsPlayer.src = url;
        hlsPlayer.addEventListener('loadedmetadata', function() {
          hlsPlayer.play().catch(error => {
            console.log("Autoplay was prevented, user interaction is likely required.", error);
          });
        });
      } else if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(hlsPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          hlsPlayer.play().catch(error => {
            console.log("Autoplay was prevented, user interaction is likely required.", error);
          });
        });
      }
    }

    playHlsLocally('https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8');
  </script>
</html>